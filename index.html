<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ô‡∏û‡∏¥‡∏Å‡∏≤‡∏£</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- LeafletJS for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Leaflet MarkerCluster -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Kanit', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #495057;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #343a40;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header p {
            color: #6c757d;
            font-size: 1.1rem;
            font-weight: 400;
        }

        .connection-status {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            border-left: 5px solid #28a745;
            font-weight: 500;
        }

        .connection-status.error {
            border-left-color: #dc3545;
        }

        .filters {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }

        .filter-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 12px 25px;
            background: #ffffff;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            font-family: 'Kanit', sans-serif;
            font-weight: 500;
            font-size: 1rem;
            color: #495057;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 180px;
            text-align: center;
        }

        .filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            border-color: #007bff;
        }

        .filter-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
            box-shadow: 0 6px 25px rgba(0, 123, 255, 0.3);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 15px;
        }

        .tab {
            padding: 12px 25px;
            background: transparent;
            border: none;
            border-radius: 10px;
            font-family: 'Kanit', sans-serif;
            font-weight: 500;
            color: #007bff;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            text-align: center;
        }

        .tab.active {
            background: #007bff;
            color: white;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }

        .tab:hover:not(.active) {
            background: rgba(0, 123, 255, 0.1);
        }

        .content { display: none; }
        .content.active { display: block; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
            border-top: 4px solid #007bff;
        }
        .stat-card:nth-child(2) { border-top-color: #28a745; }
        .stat-card:nth-child(3) { border-top-color: #ffc107; }
        .stat-card:nth-child(4) { border-top-color: #17a2b8; }


        .stat-card:hover { transform: translateY(-5px); }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #343a40;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #6c757d;
            font-weight: 500;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #343a40;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .chart-container {
            position: relative;
            flex-grow: 1;
        }

        .data-table {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        th {
            background: #f8f9fa;
            color: #495057;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        tr:hover { background: #e9ecef; }

        .action-btn {
            padding: 6px 12px; margin: 2px; border: none;
            border-radius: 6px; cursor: pointer; font-family: 'Kanit', sans-serif;
            font-size: 0.8rem; font-weight: 500; transition: all 0.3s ease;
        }

        .btn-view { background: #007bff; color: white; }
        .action-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        .map-container {
            background: #fff; border-radius: 15px; padding: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05); text-align: center;
            min-height: 520px; display: flex; align-items: center; justify-content: center;
        }

        .loading { color: #6c757d; font-size: 1.1rem; }
        .modal {
            display: none; position: fixed; z-index: 1000;
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6);
            overflow-y: auto;
        }

        .modal-content {
            background-color: #fefefe; margin: 2% auto; padding: 20px 30px 30px;
            border-radius: 15px; width: 90%; max-width: 800px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        
        .modal-header h2 { color: #343a40; }

        .close {
            color: #aaa; font-size: 35px; font-weight: bold;
            cursor: pointer; line-height: 1;
        }
        .close:hover { color: #000; }

        .btn-primary {
            background: #007bff; color: white; padding: 12px 25px; border: none;
            border-radius: 8px; cursor: pointer; font-family: 'Kanit', sans-serif;
            font-weight: 500; transition: all 0.3s ease;
        }

        .btn-primary:hover { background: #0056b3; box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3); }
        .status-indicator {
            position: fixed; top: 20px; right: 20px; padding: 10px 20px;
            border-radius: 25px; color: white; font-weight: 500;
            z-index: 1001; transition: all 0.5s ease;
        }

        .status-loading { background: #ffc107; color: #212529;}
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        
        .modal-body { display: grid; grid-template-columns: 1fr 2fr; gap: 15px 25px; }
        .modal-body strong { color: #495057; }
        .modal-body p { margin: 0; line-height: 1.6; }
        .section-title {
            grid-column: 1 / -1;
            font-size: 1.1rem;
            font-weight: 600;
            color: #007bff;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        .section-title:first-child { margin-top: 0; }
        .profile-image {
            width: 150px; height: 150px; border-radius: 50%;
            object-fit: cover; border: 4px solid #dee2e6;
            margin-bottom: 15px;
        }

        .leaflet-popup-content-wrapper {
            font-family: 'Kanit', sans-serif;
            border-radius: 8px;
        }


        @media (max-width: 768px) {
            .filter-buttons { flex-direction: column; align-items: stretch; }
            .filter-btn { min-width: auto; width: 100%; }
            .tabs { flex-direction: column; }
            .charts-grid { grid-template-columns: 1fr; }
            .header h1 { font-size: 2rem; }
            .modal-content { width: 95%; margin: 2% auto; padding: 20px; }
            .modal-body { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="statusIndicator" class="status-indicator" style="display: none;"></div>
    
    <div class="container">
        <div class="header">
            <h1>üìä Dashboard ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h1>
            <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ô‡∏û‡∏¥‡∏Å‡∏≤‡∏£</p>
        </div>

        <div id="connectionStatus" class="connection-status">
            üîó ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...
        </div>

        <div class="filters">
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="setMainFilter('all')">üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                <button class="filter-btn" onclick="setMainFilter('elderly')">üë¥ ‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏</button>
                <button class="filter-btn" onclick="setMainFilter('disabled')">‚ôø ‡∏Ñ‡∏ô‡∏û‡∏¥‡∏Å‡∏≤‡∏£</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('overview')">üìà ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</button>
            <button class="tab" onclick="showTab('datatable')">üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</button>
            <button class="tab" onclick="showTab('map')">üó∫Ô∏è ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏Å‡∏±‡∏î</button>
        </div>

        <div id="overview" class="content active">
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-number" id="totalCount">0</div><div class="stat-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div></div>
                <div class="stat-card"><div class="stat-number" id="elderlyCount">0</div><div class="stat-label">‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏</div></div>
                <div class="stat-card"><div class="stat-number" id="disabledCount">0</div><div class="stat-label">‡∏Ñ‡∏ô‡∏û‡∏¥‡∏Å‡∏≤‡∏£</div></div>
                <div class="stat-card"><div class="stat-number" id="bothCount">0</div><div class="stat-label">‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏ & ‡∏û‡∏¥‡∏Å‡∏≤‡∏£</div></div>
            </div>

            <div class="charts-grid">
                <div class="chart-card"><div class="chart-title">üìä ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</div><div class="chart-container"><canvas id="targetGroupChart"></canvas></div></div>
                <div class="chart-card"><div class="chart-title">üí∞ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div><div class="chart-container"><canvas id="incomeChart"></canvas></div></div>
                <div class="chart-card"><div class="chart-title">‚ôø ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¥‡∏Å‡∏≤‡∏£</div><div class="chart-container"><canvas id="disabilityTypeChart"></canvas></div></div>
                <div class="chart-card"><div class="chart-title">üè† ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢</div><div class="chart-container"><canvas id="housingTypeChart"></canvas></div></div>
                <div class="chart-card"><div class="chart-title">üíº ‡∏≠‡∏≤‡∏ä‡∏µ‡∏û</div><div class="chart-container"><canvas id="occupationChart"></canvas></div></div>
                <div class="chart-card"><div class="chart-title">üéì ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</div><div class="chart-container"><canvas id="educationChart"></canvas></div></div>
                <div class="chart-card"><div class="chart-title">üè• ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</div><div class="chart-container"><canvas id="healthChart"></canvas></div></div>
                <div class="chart-card"><div class="chart-title">üë• ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏</div><div class="chart-container"><canvas id="ageChart"></canvas></div></div>
                <div class="chart-card"><div class="chart-title">ü§ù ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô</div><div class="chart-container"><canvas id="assistanceChart"></canvas></div></div>
            </div>
        </div>

        <div id="datatable" class="content">
            <div class="data-table">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: #343a40;">üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</h3>
                    <button class="btn-primary" onclick="refreshData()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                            <th>‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</th>
                            <th>‡∏≠‡∏≤‡∏¢‡∏∏</th>
                            <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</th>
                            <th>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="map" class="content">
            <div class="map-container">
                <div id="mapid" style="width: 100%; height: 500px; border-radius: 15px;"></div>
            </div>
        </div>
    </div>

    <div id="recordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="recordDetails" class="modal-body-container"></div>
        </div>
    </div>

    <!-- LeafletJS for Map -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Leaflet MarkerCluster -->
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script>
        // --- Configuration ---
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzG-48MY7WsT_welV9rtDNDW2N41e_RWPVeKRLf-OvAcEr7ZYv0cxsGFuv7-Shyfa6cNw/exec';
        const CHART_COLORS = ['#007bff', '#28a745', '#ffc107', '#17a2b8', '#6610f2', '#fd7e14', '#e83e8c', '#6f42c1', '#20c997'];
        
        let allData = [];
        let filteredData = [];
        let charts = {};
        let map;
        let markersLayer;

        // --- Map Icons ---
        const createIcon = (color) => new L.Icon({
            iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
            shadowUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
        const greenIcon = createIcon('green');
        const yellowIcon = createIcon('yellow');
        const redIcon = createIcon('red');
        const greyIcon = createIcon('grey');


        // --- Chart.js Plugin for No Data ---
        const noDataPlugin = {
            id: 'noData',
            afterDraw(chart) {
                if (chart.data.datasets.every(d => d.data.length === 0)) {
                    const { ctx, chartArea: { left, top, right, bottom } } = chart;
                    ctx.save();
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.font = "16px 'Kanit', sans-serif";
                    ctx.fillStyle = '#6c757d';
                    ctx.fillText('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•', (left + right) / 2, (top + bottom) / 2);
                    ctx.restore();
                }
            }
        };
        Chart.register(noDataPlugin);

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            // setInterval(loadData, 60000); // Auto-refresh disabled by user request
        });

        // --- UI Feedback Functions ---
        function showStatus(message, type = 'loading') {
            const el = document.getElementById('statusIndicator');
            el.textContent = message;
            el.className = `status-indicator status-${type}`;
            el.style.display = 'block';
            if (type !== 'loading') {
                setTimeout(() => { el.style.display = 'none'; }, 3000);
            }
        }

        function updateConnectionStatus(success, message) {
            const el = document.getElementById('connectionStatus');
            el.className = `connection-status ${success ? '' : 'error'}`;
            el.innerHTML = `${success ? 'üîó' : '‚ö†Ô∏è'} ${message}`;
        }

        // --- Data Loading ---
        function loadData() {
            if (WEB_APP_URL.includes('‡πÉ‡∏™‡πà WEB APP URL')) {
                updateConnectionStatus(false, '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Apps Script URL');
                showStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Web App URL', 'error');
                loadSampleData();
                return;
            }
            
            showStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', 'loading');
            fetch(WEB_APP_URL)
                .then(response => {
                    if (!response.ok) throw new Error(`Network Error: ${response.statusText}`);
                    return response.json();
                })
                .then(data => {
                    if (data.error) throw new Error(`Script Error: ${data.details}`);
                    onDataLoaded(data);
                    showStatus('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                    updateConnectionStatus(true, `‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${new Date().toLocaleTimeString('th-TH')}`);
                })
                .catch(error => {
                    console.error('Data Loading Failed:', error);
                    updateConnectionStatus(false, '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Web App ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á');
                    showStatus('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Web App ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
                    loadSampleData();
                });
        }
        
        function onDataLoaded(data) {
            allData = Array.isArray(data) ? data : [];
            allData.forEach((item, index) => {
                item.__internal_id = index; // Add a unique internal ID for robust lookups
                item['ID'] = parseInt(item['ID'], 10); // Still parse the original ID, might be NaN
                item['‡∏≠‡∏≤‡∏¢‡∏∏'] = parseInt(item['‡∏≠‡∏≤‡∏¢‡∏∏'], 10) || 0;
            });
            setMainFilter('all');
        }

        function loadSampleData() {
            const sampleData = [
                {
                    "ID": 1, "‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢": "‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏", "‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•": "‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ", "‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô": "1234567890123",
                    "‡πÄ‡∏û‡∏®": "‡∏ä‡∏≤‡∏¢", "‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î": "1-‡∏°.‡∏Ñ.-2498", "‡∏≠‡∏≤‡∏¢‡∏∏": 68, "‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà": "123 ‡∏´‡∏°‡∏π‡πà 4 ‡∏ï.‡∏ö‡πâ‡∏≤‡∏ô‡∏õ‡∏ß‡∏á ‡∏≠.‡∏ó‡∏∏‡πà‡∏á‡∏´‡∏±‡∏ß‡∏ä‡πâ‡∏≤‡∏á ‡∏à.‡∏•‡∏≥‡∏û‡∏π‡∏ô",
                    "‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ö‡πâ‡∏≤‡∏ô": "18.432, 98.654", "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå": "0812345678", "‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•": "‡∏≠‡∏™‡∏°. ‡∏ß‡∏±‡∏ô‡∏î‡∏µ", "img": "https://placehold.co/150x150/007bff/white?text=SC",
                    "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏î‡πâ‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û": "‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á(‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏¥‡∏î‡∏™‡∏±‡∏á‡∏Ñ‡∏°)", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¥‡∏Å‡∏≤‡∏£": "‡πÑ‡∏°‡πà‡∏°‡∏µ", "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤": "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡∏™‡∏π‡∏á", "‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤": "‡πÉ‡∏ä‡πâ", "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤": "‡∏¢‡∏≤‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡πÄ‡∏°‡πá‡∏î",
                    "‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•": "‡∏ô‡∏≤‡∏á‡∏™‡∏°‡∏®‡∏£‡∏µ ‡πÉ‡∏à‡∏î‡∏µ", "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•": "‡∏†‡∏£‡∏£‡∏¢‡∏≤", "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•": "0887654321", "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤": "‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤",
                    "‡∏≠‡∏≤‡∏ä‡∏µ‡∏û": "‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£", "‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô": "5,000-10,000", "‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢": "‡∏ö‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏ô‡πÄ‡∏≠‡∏á", "‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á": "‡πÑ‡∏°‡πà‡∏°‡∏µ",
                    "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô": "‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô, ‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û", "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏∑‡πà‡∏ô‡πÜ": "-", "‡∏†‡∏π‡∏°‡∏¥‡∏õ‡∏±‡∏ç‡∏ç‡∏≤/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡πÄ‡∏®‡∏©": "‡∏à‡∏±‡∏Å‡∏™‡∏≤‡∏ô", "‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞": "-", "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å": "1-‡∏Å.‡∏¢.-2568"
                },
                {
                    "ID": 2, "‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢": "‡∏Ñ‡∏ô‡∏û‡∏¥‡∏Å‡∏≤‡∏£", "‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•": "‡∏ô‡∏≤‡∏á‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡∏£‡∏±‡∏Å‡∏î‡∏µ", "‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô": "2345678901234",
                    "‡πÄ‡∏û‡∏®": "‡∏´‡∏ç‡∏¥‡∏á", "‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î": "15-‡∏°‡∏¥.‡∏¢.-2521", "‡∏≠‡∏≤‡∏¢‡∏∏": 45, "‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà": "456 ‡∏´‡∏°‡∏π‡πà 5 ‡∏ï.‡∏ö‡πâ‡∏≤‡∏ô‡∏õ‡∏ß‡∏á ‡∏≠.‡∏ó‡∏∏‡πà‡∏á‡∏´‡∏±‡∏ß‡∏ä‡πâ‡∏≤‡∏á ‡∏à.‡∏•‡∏≥‡∏û‡∏π‡∏ô",
                    "‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ö‡πâ‡∏≤‡∏ô": "18.435, 98.658", "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå": "0912345679", "‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•": "‡∏≠‡∏™‡∏°. ‡∏ß‡∏±‡∏ô‡∏î‡∏µ", "img": "https://placehold.co/150x150/28a745/white?text=SR",
                    "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏î‡πâ‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û": "‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏Ñ‡πà‡∏≠‡∏¢‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á(‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏¥‡∏î‡∏ö‡πâ‡∏≤‡∏ô)", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¥‡∏Å‡∏≤‡∏£": "‡∏û‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß", "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤": "‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô", "‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤": "‡πÉ‡∏ä‡πâ", "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤": "‡∏¢‡∏≤‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô, ‡∏≠‡∏¥‡∏ô‡∏ã‡∏π‡∏•‡∏¥‡∏ô",
                    "‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•": "‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå ‡∏£‡∏±‡∏Å‡∏î‡∏µ", "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•": "‡∏™‡∏≤‡∏°‡∏µ", "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•": "0987654322", "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤": "‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤",
                    "‡∏≠‡∏≤‡∏ä‡∏µ‡∏û": "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏≥", "‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô": "‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 5,000", "‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢": "‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏ä‡πà‡∏≤", "‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á": "‡∏°‡∏µ, ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡πÄ‡∏Ç‡πá‡∏ô",
                    "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô": "‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠, ‡∏Å‡∏≤‡∏£‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π", "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏∑‡πà‡∏ô‡πÜ": "‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢", "‡∏†‡∏π‡∏°‡∏¥‡∏õ‡∏±‡∏ç‡∏ç‡∏≤/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡πÄ‡∏®‡∏©": "‡πÄ‡∏¢‡πá‡∏ö‡∏õ‡∏±‡∏Å‡∏ñ‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏¢", "‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞": "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ô‡∏î‡∏π‡πÅ‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°", "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å": "2-‡∏Å.‡∏¢.-2568"
                },
                {
                    "ID": 3, "‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢": "‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ô‡∏û‡∏¥‡∏Å‡∏≤‡∏£", "‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•": "‡∏ô‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏ó‡∏ò‡πå ‡∏™‡∏∏‡∏Ç‡πÉ‡∏™", "‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô": "3456789012345",
                    "‡πÄ‡∏û‡∏®": "‡∏ä‡∏≤‡∏¢", "‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î": "20-‡∏û.‡∏Ñ.-2496", "‡∏≠‡∏≤‡∏¢‡∏∏": 72, "‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà": "789 ‡∏´‡∏°‡∏π‡πà 6 ‡∏ï.‡∏ö‡πâ‡∏≤‡∏ô‡∏õ‡∏ß‡∏á ‡∏≠.‡∏ó‡∏∏‡πà‡∏á‡∏´‡∏±‡∏ß‡∏ä‡πâ‡∏≤‡∏á ‡∏à.‡∏•‡∏≥‡∏û‡∏π‡∏ô",
                    "‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ö‡πâ‡∏≤‡∏ô": "18.430, 98.650", "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå": "0832109876", "‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•": "‡∏≠‡∏™‡∏°. ‡∏°‡∏≤‡∏ô‡∏µ", "img": "https://placehold.co/150x150/ffc107/white?text=PS",
                    "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏î‡πâ‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û": "‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á(‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏¥‡∏î‡πÄ‡∏ï‡∏µ‡∏¢‡∏á)", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¥‡∏Å‡∏≤‡∏£": "‡∏û‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô", "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤": "‡πÇ‡∏£‡∏Ñ‡∏´‡∏±‡∏ß‡πÉ‡∏à", "‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤": "‡πÉ‡∏ä‡πâ", "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤": "‡∏¢‡∏≤‡πÇ‡∏£‡∏Ñ‡∏´‡∏±‡∏ß‡πÉ‡∏à, ‡∏¢‡∏≤‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏™‡∏≤‡∏¢‡∏ï‡∏≤",
                    "‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•": "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏°‡∏≤‡∏ô‡∏µ ‡∏™‡∏∏‡∏Ç‡πÉ‡∏™", "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•": "‡∏ö‡∏∏‡∏ï‡∏£‡∏™‡∏≤‡∏ß", "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•": "0876543210", "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤": "‡∏õ‡∏£‡∏¥‡∏ç‡∏ç‡∏≤‡∏ï‡∏£‡∏µ",
                    "‡∏≠‡∏≤‡∏ä‡∏µ‡∏û": "‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ì‡∏µ‡∏¢‡∏ì", "‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô": "10,001-20,000", "‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢": "‡∏ö‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏ô‡πÄ‡∏≠‡∏á", "‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á": "‡∏°‡∏µ, ‡∏°‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô",
                    "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô": "‡∏î‡∏π‡πÅ‡∏•‡∏õ‡∏£‡∏∞‡∏à‡∏≥, ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå", "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏∑‡πà‡∏ô‡πÜ": "‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ô‡∏≥‡∏ó‡∏≤‡∏á", "‡∏†‡∏π‡∏°‡∏¥‡∏õ‡∏±‡∏ç‡∏ç‡∏≤/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡πÄ‡∏®‡∏©": "-", "‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞": "-", "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å": "3-‡∏Å.‡∏¢.-2568"
                }
            ];
            onDataLoaded(sampleData);
        }

        // --- Filtering and Updating ---
        function setMainFilter(filterType) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.filter-btn[onclick="setMainFilter('${filterType}')"]`).classList.add('active');
            
            if (filterType === 'all') filteredData = [...allData];
            else if (filterType === 'elderly') filteredData = allData.filter(item => item['‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢']?.includes('‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏'));
            else if (filterType === 'disabled') filteredData = allData.filter(item => item['‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢']?.includes('‡∏Ñ‡∏ô‡∏û‡∏¥‡∏Å‡∏≤‡∏£'));
            
            updateDashboard();
        }

        function updateDashboard() {
            updateStats();
            updateCharts();
            updateTable();
            if (document.getElementById('map').classList.contains('active')) {
                updateMap();
            }
        }

        // --- Component Update Functions ---
        function updateStats() {
            document.getElementById('totalCount').textContent = filteredData.length;
            document.getElementById('elderlyCount').textContent = filteredData.filter(item => item['‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢']?.includes('‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏')).length;
            document.getElementById('disabledCount').textContent = filteredData.filter(item => item['‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢']?.includes('‡∏Ñ‡∏ô‡∏û‡∏¥‡∏Å‡∏≤‡∏£')).length;
            document.getElementById('bothCount').textContent = filteredData.filter(item => item['‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢']?.includes('‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏') && item['‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢']?.includes('‡∏Ñ‡∏ô‡∏û‡∏¥‡∏Å‡∏≤‡∏£')).length;
        }

        function updateCharts() {
            createOrUpdateChart('targetGroupChart', 'pie', getDataCount('‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢'));
            createOrUpdateChart('incomeChart', 'doughnut', getDataCount('‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'));
            createOrUpdateChart('occupationChart', 'bar', getDataCount('‡∏≠‡∏≤‡∏ä‡∏µ‡∏û'), { indexAxis: 'y' });
            createOrUpdateChart('educationChart', 'pie', getDataCount('‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤'));
            createOrUpdateChart('healthChart', 'doughnut', getDataCount('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏î‡πâ‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û'));
            createOrUpdateChart('ageChart', 'bar', getAgeRangeData());
            createOrUpdateChart('assistanceChart', 'bar', getAssistanceData(), { indexAxis: 'y' });
            createOrUpdateChart('disabilityTypeChart', 'pie', getDataCount('‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¥‡∏Å‡∏≤‡∏£'));
            createOrUpdateChart('housingTypeChart', 'doughnut', getDataCount('‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢'));
        }

        function updateTable() {
            const tbody = document.querySelector('#dataTable tbody');
            tbody.innerHTML = filteredData.map((item) => `
                <tr>
                    <td>${item['‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'] || ''}</td>
                    <td>${item['‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢'] || ''}</td>
                    <td>${item['‡∏≠‡∏≤‡∏¢‡∏∏'] || ''}</td>
                    <td>${item['‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå'] || ''}</td>
                    <td><button class="action-btn btn-view" onclick="viewRecord(${item.__internal_id})">‡∏î‡∏π</button></td>
                </tr>
            `).join('');
        }

        // --- Chart Logic ---
        function createOrUpdateChart(canvasId, type, data, extraOptions = {}) {
            const labels = Object.keys(data);
            const values = Object.values(data);
            const ctx = document.getElementById(canvasId).getContext('2d');

            if (charts[canvasId]) {
                charts[canvasId].data.labels = labels;
                charts[canvasId].data.datasets[0].data = values;
                charts[canvasId].update();
            } else {
                charts[canvasId] = new Chart(ctx, {
                    type,
                    data: { labels, datasets: [{ data: values, backgroundColor: CHART_COLORS, borderWidth: 0 }] },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom', display: ['pie', 'doughnut'].includes(type) },
                            tooltip: { callbacks: { 
                                label: (c) => {
                                    const total = c.chart.getDatasetMeta(0).total;
                                    const percentage = total > 0 ? ((c.raw / total) * 100).toFixed(1) : 0;
                                    return `${c.label}: ${c.raw} (${percentage}%)`;
                                }
                             } }
                        },
                        scales: type === 'bar' ? { 
                            [extraOptions.indexAxis === 'y' ? 'x' : 'y']: { beginAtZero: true, ticks: { precision: 0 } }
                        } : {},
                        ...extraOptions
                    }
                });
            }
        }

        // --- Data Processing for Charts ---
        function getDataCount(field) {
            return filteredData.reduce((acc, item) => {
                const value = item[field] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                acc[value] = (acc[value] || 0) + 1;
                return acc;
            }, {});
        }

        function getAgeRangeData() {
            const ranges = { '0-30': 0, '31-40': 0, '41-50': 0, '51-60': 0, '61-70': 0, '71-80': 0, '81+': 0 };
            filteredData.forEach(item => {
                const age = item['‡∏≠‡∏≤‡∏¢‡∏∏'];
                if (age <= 30) ranges['0-30']++;
                else if (age <= 40) ranges['31-40']++;
                else if (age <= 50) ranges['41-50']++;
                else if (age <= 60) ranges['51-60']++;
                else if (age <= 70) ranges['61-70']++;
                else if (age <= 80) ranges['71-80']++;
                else ranges['81+']++;
            });
            return ranges;
        }

        function getAssistanceData() {
            const needs = {};
            filteredData.forEach(item => {
                const assistance = item['‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô'];
                if (assistance) {
                    assistance.split(/[,ÿå]/).map(a => a.trim()).filter(a => a).forEach(n => {
                        needs[n] = (needs[n] || 0) + 1;
                    });
                }
            });
            return needs;
        }

        // --- Map Logic ---
        function initializeMap() {
            if (map) return; // Initialize only once
            map = L.map('mapid').setView([17.87097381778819, 99.06920245255928], 11); // Set initial view
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            markersLayer = L.markerClusterGroup().addTo(map);
        }

        function updateMap() {
            if (!map) return;
            markersLayer.clearLayers();

            filteredData.forEach(item => {
                const coordsStr = item['‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ö‡πâ‡∏≤‡∏ô'];
                if (coordsStr && typeof coordsStr === 'string') {
                    const parts = coordsStr.split(',').map(part => parseFloat(part.trim()));
                    if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
                        const [lat, lon] = parts;

                        // Select icon based on health status
                        let icon = greyIcon; // Default
                        const healthStatus = item['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏î‡πâ‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û'];
                        if (healthStatus === '‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á(‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏¥‡∏î‡∏™‡∏±‡∏á‡∏Ñ‡∏°)') {
                            icon = greenIcon;
                        } else if (healthStatus === '‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏Ñ‡πà‡∏≠‡∏¢‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á(‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏¥‡∏î‡∏ö‡πâ‡∏≤‡∏ô)') {
                            icon = yellowIcon;
                        } else if (healthStatus === '‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á(‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏¥‡∏î‡πÄ‡∏ï‡∏µ‡∏¢‡∏á)') {
                            icon = redIcon;
                        }

                        const marker = L.marker([lat, lon], { icon: icon });
                        marker.bindPopup(`
                            <b>${item['‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•']}</b><br>
                            ‡∏Å‡∏•‡∏∏‡πà‡∏°: ${item['‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢']}<br>
                            ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û: ${healthStatus || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}<br>
                            ‡∏≠‡∏≤‡∏¢‡∏∏: ${item['‡∏≠‡∏≤‡∏¢‡∏∏']} ‡∏õ‡∏µ
                        `);
                        markersLayer.addLayer(marker);
                    }
                }
            });
        }

        // --- UI Interaction ---
        function showTab(tabName) {
            document.querySelectorAll('.content, .tab').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`.tab[onclick="showTab('${tabName}')"]`).classList.add('active');
            
            if (tabName === 'map') {
                initializeMap();
                setTimeout(() => map.invalidateSize(), 10); // Fix map rendering issue
                updateMap();
            }
        }
        
        function viewRecord(internalId) {
            const item = allData.find(d => d.__internal_id === internalId);
            if (!item) { 
                console.error(`Record with internal ID ${internalId} not found.`); 
                return; 
            }

            document.getElementById('modalTitle').textContent = `‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${item['‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•']}`;
            
            const detailsContainer = document.getElementById('recordDetails');
            detailsContainer.innerHTML = ''; // Clear previous content

            const imageContainer = document.createElement('div');
            imageContainer.style.textAlign = 'center';
            imageContainer.innerHTML = `<img src="${item['img'] || 'https://placehold.co/150x150/ced4da/6c757d?text=No+Image'}" alt="‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢" class="profile-image">`;
            detailsContainer.appendChild(imageContainer);
            
            const modalBody = document.createElement('div');
            modalBody.className = 'modal-body';
            
            const createField = (label, value) => `<strong>${label}</strong><p>${value || '-'}</p>`;
            
            const sections = {
                '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß': [
                    { label: 'ID', key: 'ID' }, { label: '‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô', key: '‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô' },
                    { label: '‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢', key: '‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢' }, { label: '‡πÄ‡∏û‡∏®', key: '‡πÄ‡∏û‡∏®' },
                    { label: '‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î', key: '‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î' }, { label: '‡∏≠‡∏≤‡∏¢‡∏∏', key: '‡∏≠‡∏≤‡∏¢‡∏∏', suffix: ' ‡∏õ‡∏µ' },
                    { label: '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå', key: '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå' }, { label: '‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà', key: '‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà' },
                    { label: '‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ö‡πâ‡∏≤‡∏ô', key: '‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ö‡πâ‡∏≤‡∏ô' },
                ],
                '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û': [
                    { label: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏î‡πâ‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û', key: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏î‡πâ‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û' }, { label: '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¥‡∏Å‡∏≤‡∏£', key: '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¥‡∏Å‡∏≤‡∏£' },
                    { label: '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤', key: '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤' }, { label: '‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤', key: '‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤' },
                    { label: '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤', key: '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤' },
                ],
                '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•': [
                    { label: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•', key: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•' }, { label: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå', key: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•' },
                    { label: '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•', key: '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•' },
                ],
                '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ': [
                    { label: '‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤', key: '‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤' }, { label: '‡∏≠‡∏≤‡∏ä‡∏µ‡∏û', key: '‡∏≠‡∏≤‡∏ä‡∏µ‡∏û' },
                    { label: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', key: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', suffix: ' ‡∏ö‡∏≤‡∏ó' }, { label: '‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢', key: '‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢' },
                    { label: '‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á', key: '‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á' }, { label: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô', key: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô' },
                    { label: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏∑‡πà‡∏ô‡πÜ', key: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏∑‡πà‡∏ô‡πÜ' }, { label: '‡∏†‡∏π‡∏°‡∏¥‡∏õ‡∏±‡∏ç‡∏ç‡∏≤/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡πÄ‡∏®‡∏©', key: '‡∏†‡∏π‡∏°‡∏¥‡∏õ‡∏±‡∏ç‡∏ç‡∏≤/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡πÄ‡∏®‡∏©' },
                    { label: '‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞', key: '‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞' }, { label: '‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', key: '‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' },
                    { label: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', key: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å' }
                ]
            };
            
            for (const [sectionTitle, fields] of Object.entries(sections)) {
                modalBody.innerHTML += `<div class="section-title">${sectionTitle}</div>`;
                fields.forEach(field => {
                    const value = isNaN(item[field.key]) ? item[field.key] : (item[field.key] || (field.key === 'ID' ? 'N/A' : null));
                    const displayValue = value ? `${value}${field.suffix || ''}` : null;
                    modalBody.innerHTML += createField(field.label, displayValue);
                });
            }

            detailsContainer.appendChild(modalBody);
            document.getElementById('recordModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('recordModal').style.display = 'none';
        }

        function refreshData() {
            loadData();
        }

        window.onclick = (event) => {
            if (event.target === document.getElementById('recordModal')) closeModal();
        };
        // --- Configuration ---
// Replace with your Google Sheet ID.
const SPREADSHEET_ID = "10cc7gHhj_sHaz33RTIceZjqBe0VfYNDYOLH8mn5ld_U";
// Replace with the name of the sheet that contains your data.
const SHEET_NAME = "SurveyData";
const IMAGE_FOLDER_NAME = "Dashboard_Images";


/**
 * Serves the HTML file for the web app's user interface.
 * This is the main entry point when a user visits the web app URL.
 */
function doGet(e) {
  return HtmlService.createHtmlOutputFromFile('index')
      .setTitle("Dashboard_SurveyData")
      .addMetaTag('viewport', 'width=device-width, initial-scale=1.0');
}


/**
 * Fetches data from the Google Sheet and returns it as an array of objects.
 * This function is called from the client-side JavaScript.
 * @returns {Array<Object> | Object} The data from the spreadsheet or an error object.
 */
function getData() {
  try {
    const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);
    if (!sheet) {
      throw new Error(`Sheet "${SHEET_NAME}" not found.`);
    }
    const dataRange = sheet.getDataRange();
    const values = dataRange.getValues();
    
    if (values.length < 2) {
      return []; // No data rows
    }
    
    const headers = values[0].map(header => header.trim());
    const data = [];

    for (let i = 1; i < values.length; i++) {
      const row = values[i];
      // Skip empty rows where the first cell is empty
      if (row[0] === "" || row[0] == null) {
        continue;
      }
      
      const obj = {};
      for (let j = 0; j < headers.length; j++) {
        const header = headers[j];
        // Convert dates to a readable string format if they are Date objects
        obj[header] = (row[j] instanceof Date) ? row[j].toLocaleDateString('th-TH') : row[j];
      }
      data.push(obj);
    }
    
    return data;
  } catch (e) {
    console.error("Error in getData: " + e.toString());
    // In case of an error, return an object that the client can check
    return { error: true, details: e.message };
  }
}


/**
 * Gets or creates a folder in Google Drive for storing images.
 * @returns {GoogleAppsScript.Drive.Folder} The Google Drive folder object.
 */
function getOrCreateImageFolder() {
  const folders = DriveApp.getFoldersByName(IMAGE_FOLDER_NAME);
  if (folders.hasNext()) {
    return folders.next();
  } else {
    return DriveApp.createFolder(IMAGE_FOLDER_NAME);
  }
}

/**
 * Uploads a Base64 encoded image to Google Drive and returns its public URL.
 * This function is intended to be called from the client-side for future use (e.g., in a data entry form).
 * @param {string} base64Data The Base64 string of the image.
 * @returns {string | null} The public URL of the uploaded image or null on failure.
 */
function uploadImageToDrive(base64Data) {
  try {
    const folder = getOrCreateImageFolder();
    const splitData = base64Data.split(',');
    const contentType = splitData[0].match(/:(.*?);/)[1];
    const decodedData = Utilities.base64Decode(splitData[1]);
    const blob = Utilities.newBlob(decodedData, contentType, `photo_${new Date().getTime()}.jpg`);
    
    const file = folder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    return `https://drive.google.com/uc?id=${file.getId()}`;
  } catch (e) {
    console.error("Error uploading image to Drive: " + e.toString());
    return null;
  }
}


    </script>
</body>
</html>

